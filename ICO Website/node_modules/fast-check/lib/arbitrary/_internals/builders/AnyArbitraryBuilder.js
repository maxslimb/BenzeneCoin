"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.anyArbitraryBuilder = void 0;
const stringify_1 = require("../../../utils/stringify");
const array_1 = require("../../array");
const frequency_1 = require("../../frequency");
const oneof_1 = require("../../oneof");
const set_1 = require("../../set");
const tuple_1 = require("../../tuple");
const bigInt_1 = require("../../bigInt");
const date_1 = require("../../date");
const float32Array_1 = require("../../float32Array");
const float64Array_1 = require("../../float64Array");
const int16Array_1 = require("../../int16Array");
const int32Array_1 = require("../../int32Array");
const int8Array_1 = require("../../int8Array");
const uint16Array_1 = require("../../uint16Array");
const uint32Array_1 = require("../../uint32Array");
const uint8Array_1 = require("../../uint8Array");
const uint8ClampedArray_1 = require("../../uint8ClampedArray");
const sparseArray_1 = require("../../sparseArray");
const KeyValuePairsToObject_1 = require("../mappers/KeyValuePairsToObject");
const Converters_1 = require("../../../check/arbitrary/definition/Converters");
const ArrayToMap_1 = require("../mappers/ArrayToMap");
const ArrayToSet_1 = require("../mappers/ArrayToSet");
const ObjectToPrototypeLess_1 = require("../mappers/ObjectToPrototypeLess");
const letrec_1 = require("../../letrec");
function entriesOf(keyArb, valueArb, maxKeys) {
    return (0, Converters_1.convertToNext)((0, set_1.set)((0, tuple_1.tuple)(keyArb, valueArb), {
        maxLength: maxKeys,
        compare: { type: 'SameValueZero', selector: (t) => t[0] },
    }));
}
function mapOf(ka, va, maxKeys) {
    return (0, Converters_1.convertFromNext)(entriesOf(ka, va, maxKeys).map(ArrayToMap_1.arrayToMapMapper, ArrayToMap_1.arrayToMapUnmapper));
}
function dictOf(ka, va, maxKeys) {
    return (0, Converters_1.convertFromNext)(entriesOf(ka, va, maxKeys).map(KeyValuePairsToObject_1.keyValuePairsToObjectMapper, KeyValuePairsToObject_1.keyValuePairsToObjectUnmapper));
}
function setOf(va, maxKeys) {
    return (0, Converters_1.convertFromNext)((0, Converters_1.convertToNext)((0, set_1.set)(va, { maxLength: maxKeys, compare: { type: 'SameValueZero' } })).map(ArrayToSet_1.arrayToSetMapper, ArrayToSet_1.arrayToSetUnmapper));
}
function prototypeLessOf(objectArb) {
    return (0, Converters_1.convertFromNext)((0, Converters_1.convertToNext)(objectArb).map(ObjectToPrototypeLess_1.objectToPrototypeLessMapper, ObjectToPrototypeLess_1.objectToPrototypeLessUnmapper));
}
function typedArray() {
    return (0, oneof_1.oneof)((0, int8Array_1.int8Array)(), (0, uint8Array_1.uint8Array)(), (0, uint8ClampedArray_1.uint8ClampedArray)(), (0, int16Array_1.int16Array)(), (0, uint16Array_1.uint16Array)(), (0, int32Array_1.int32Array)(), (0, uint32Array_1.uint32Array)(), (0, float32Array_1.float32Array)(), (0, float64Array_1.float64Array)());
}
function anyArbitraryBuilder(constraints) {
    const arbitrariesForBase = constraints.values;
    const depthFactor = constraints.depthFactor;
    const maxDepth = constraints.maxDepth;
    const maxKeys = constraints.maxKeys;
    const baseArb = (0, oneof_1.oneof)(...arbitrariesForBase);
    return (0, letrec_1.letrec)((tie) => ({
        anything: (0, oneof_1.oneof)({ maxDepth, depthFactor }, baseArb, tie('array'), tie('object'), ...(constraints.withMap ? [tie('map')] : []), ...(constraints.withSet ? [tie('set')] : []), ...(constraints.withObjectString ? [tie('anything').map((o) => (0, stringify_1.stringify)(o))] : []), ...(constraints.withNullPrototype ? [prototypeLessOf(tie('object'))] : []), ...(constraints.withBigInt ? [(0, bigInt_1.bigInt)()] : []), ...(constraints.withDate ? [(0, date_1.date)()] : []), ...(constraints.withTypedArray ? [typedArray()] : []), ...(constraints.withSparseArray ? [(0, sparseArray_1.sparseArray)(tie('anything'), { maxNumElements: maxKeys })] : [])),
        keys: constraints.withObjectString
            ? (0, frequency_1.frequency)({ arbitrary: constraints.key, weight: 10 }, { arbitrary: tie('anything').map((o) => (0, stringify_1.stringify)(o)), weight: 1 })
            : constraints.key,
        arrayBase: (0, oneof_1.oneof)(...arbitrariesForBase.map((arb) => (0, array_1.array)(arb, { maxLength: maxKeys }))),
        array: (0, oneof_1.oneof)(tie('arrayBase'), (0, array_1.array)(tie('anything'), { maxLength: maxKeys })),
        setBase: (0, oneof_1.oneof)(...arbitrariesForBase.map((arb) => setOf(arb, maxKeys))),
        set: (0, oneof_1.oneof)(tie('setBase'), setOf(tie('anything'), maxKeys)),
        mapBase: (0, oneof_1.oneof)(...arbitrariesForBase.map((arb) => mapOf(tie('keys'), arb, maxKeys))),
        map: (0, oneof_1.oneof)(tie('mapBase'), (0, oneof_1.oneof)(mapOf(tie('keys'), tie('anything'), maxKeys), mapOf(tie('anything'), tie('anything'), maxKeys))),
        objectBase: (0, oneof_1.oneof)(...arbitrariesForBase.map((arb) => dictOf(tie('keys'), arb, maxKeys))),
        object: (0, oneof_1.oneof)(tie('objectBase'), dictOf(tie('keys'), tie('anything'), maxKeys)),
    })).anything;
}
exports.anyArbitraryBuilder = anyArbitraryBuilder;
